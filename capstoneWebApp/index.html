<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- web app header -->
    <div class="app-header">
        <div class="logo-container">
            <img src="static/Image/logo.jpg" class="logo" style="width:65px; height:65px;" alt="Unilever Logo" >
            <h1>Hello, U!</h1>
        </div>
        <p>Ask me what you want to know</p>
    </div>

    <div class = "sidebar">
        <!-- create new chat -->
        <form method="post" action="/start_new_chat">
            <div class="chat-button-container">
                <h2 style = "font-family: sans-serif; font-size: 12px;">Start <br> New Chat</h2>
                <button type="submit" id="new-chat" class="new-chat">
                    <img src="static/Image/new-chat.png" alt="Icon" style="width: 45px; height: 45px; margin-left:8px;">
                </button>
            </div>
        </form>

        <!-- dropdown menu for Year -->
        <div id = "year" class="select">
            <div class="select-header">
              <img src="static/Image/calendar.png" style="width:30px; height:30px;" alt="year">
              <span style="margin-left: 10px;">Year</span>
            </div>

            <div class="select-button">
                <p class="select-text">Select a year</p>
                <img src="static/Image/arrow-down.png" style="width:15px; height:15px; margin-right: 10px" alt="dropdown">
            </div>
            <!-- options -->
            <ul class="options">
              <li class = "option">2016</li>
              <li class = "option">2017</li>
              <li class = "option">2018</li>
              <li class = "option">2019</li>
              <li class = "option">2020</li>
              <li class = "option">2021</li>
              <li class = "option">2022</li>
              <li class = "option">2023</li>
            </ul>
        </div>

        <!-- dropdown menu for Company -->
        <div id = "company" class="select">

            <div class="select-header">
              <img src="static/Image/office-building.png" style="width:30px; height:30px;" alt="company">
              <span style="margin-left: 10px;">Company</span>
            </div>

            <div class="select-button">
                <p class="select-text">Select a company</p>
                <img src="static/Image/arrow-down.png" style="width:15px; height:15px; margin-right: 10px" alt="dropdown">
            </div>
            <!-- options -->
            <ul class="options">
              <li class = "option">Unilever</li>
              <li class = "option">P&G</li>
              <li class = "option">Nestle</li>
              <li class = "option">L'Oreal</li>
              <li class = "option">Colgate</li>
            </ul>
        </div>

    </div>


    <!-- Chat Area -->
    <div class="chat-container">
        <div class="chat-history" id="chat-history">
        </div>
      <!-- user input text box-->

      <form method="post" action="/send_message" onsubmit="return validateForm()">
        <div class="chat-form-container">
            <textarea class="chat-input" name="message" id="messageText" placeholder="Send a message"></textarea>
            <button class="process-chat" type="submit" id="send-message"> <img src="static/Image/send.png" style="width:35px; height:35px;" alt="send"></button>
        </div>
        <input type="hidden" id="selected-year" name="year">
        <input type="hidden" id="selected-company" name="company">
      </form>
    </div>

    <script>
        /* Dropdown menus */
        const dropdowns = document.querySelectorAll(".select")
        for(let i = 0; i < dropdowns.length; i++){
          const dropdown = dropdowns[i];
          const select_button = dropdown.querySelector(".select-button")
          const options = dropdown.querySelectorAll(".option")
          const select_text = dropdown.querySelector(".select-text");

           select_button.addEventListener("click", function(){
             dropdown.classList.toggle("active");
           });

           for(let j = 0; j<options.length; j++){
             options[j].addEventListener("click", function(){
               let select_value = this.innerText;
               select_text.innerText = select_value;
               dropdown.classList.remove("active");
               dropdown.getElementsByClassName("className")
               document.getElementById("selected-" + dropdown.id).value = select_value;
             });
           }
        }
        /* chat message */
        function validateForm() {
            var messageInput = document.getElementById("messageText");
            var yearInput = document.getElementById("selected-year");
            var companyInput = document.getElementById("selected-company");

            if (messageInput.value.trim() === "") {
                alert("Message cannot be empty");
                return false;
            }
            if (yearInput.value.trim() === "") {
                alert("Year cannot be empty");
                return false;
            }
            if (companyInput.value.trim() === "") {
                alert("Company cannot be empty");
                return false;
            }
            // If all fields are non-empty, allow form submission
            return true;
        }
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatHistory = document.getElementById('chat-history');

        // 监听表单提交事件
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // 防止表单默认提交

            // 获取用户输入的消息
            const message = messageInput.value;

            // 发送消息到后端并等待响应
            const response = await fetch('/send_message', {
                method: 'POST',
                body: new URLSearchParams({
                    message: message,
                    year: document.getElementById('selected-year').value,
                    company: document.getElementById('selected-company').value
                }),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            });

            // 解析后端返回的数据
            const data = await response.json();

            // 创建新的消息元素并添加到聊天历史容器中
            const messageElement = document.createElement('div');
            messageElement.textContent = `${data.year} - ${data.company}: ${data.message}`;
            chatHistory.appendChild(messageElement);

            // 清空输入框
            messageInput.value = '';
        });

    </script>
</body>
</html>